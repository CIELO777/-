<template>
  <div class="ChatCustomer">
    <!-- ä¼ä¸šå¾®ä¿¡éªŒè¯ç  -->
    <BindPop :shows="show" @BindComplete="BindCompletes"></BindPop>
  </div>
</template>
<script>
import wxxx from '../../uilts/wxconfig';
import wxxxChat from '../../uilts/wxconfigChat';
import { Toolbar } from '../../uilts/toolbarMixin';
import local from '../../uilts/localStorage';
import BindPop from '../../components/ChatCustomer/BindPop'
import { generateTimeout, generateNonce, generateSignature3 } from "../../uilts/tools";
let timeout = generateTimeout();
let nonce = generateNonce();
export default {
  name: "ChatCustomer",
  components: { BindPop },
  mixins: [Toolbar],
  data() {
    return {
      active: 0,
      TabActive: 0,
      code: '',
      UserId: '',
      open_userid: '',
      CorpId: '',
      Single: false,
      compId: '',
      detailsPop: false,
      star: {
        data: '',
        pop: false,
        actions: [
          {
            name: "æœªçŸ¥",
            starLevel: 0,
          },
          {
            name: "ä¸€æ˜Ÿ",
            starLevel: 1,
          },
          {
            name: "äºŒæ˜Ÿ",
            starLevel: 2,
          },
          {
            name: "ä¸‰æ˜Ÿ",
            starLevel: 3,
          },
          {
            name: "å››æ˜Ÿ",
            starLevel: 4,
          },
          {
            name: "äº”æ˜Ÿ",
            starLevel: 5,
          },
        ]
      },
      wxcrmId: '',
      userInfo: {},
      name: '',
      sms: '',
      codes: "",
      times: 60,
      coinNumber: 0,
      sendings: "å‘é€éªŒè¯ç ",
    };
  },
  watch: {
    show(val, oldVal) {//æ™®é€šçš„watchç›‘å¬
      if (val) {
        this.$toast.clear();
      }
    },
  },
  methods: {
    starEnter(action, index) { // æ˜Ÿçº§é€‰æ‹©
      this.star.pop = false;
      this.star.data = action.name;
    },
    starSelect() {
      this.star.pop = true;
    },
    async verifyWxId() { // æ ¡éªŒwxcrmID æŸ¥è¯¢è”ç³»äººåˆ—è¡¨æ˜¯å¦å­˜åœ¨
      let signature = generateSignature3(
        this.$C || local.C(),
        this.$U || local.U(),
        timeout,
        nonce
      );
      let param = new URLSearchParams();
      param.append("userId", this.$U || local.U());
      param.append("compId", this.$C || local.C());
      param.append("timeout", timeout);
      param.append("nonce", nonce);
      param.append("wxCrmId", this.wxcrmId);
      param.append("current", 1); // é»˜è®¤é¡µæ•°æ˜¯1
      param.append("signature", signature);
      await this.$post1("/api/request/itr/comp/customer/query", param)
        .then((res) => {
          console.log(this.wxcrmId, this.name, 'this.wxcrmId, name: this.name')
          // alert(res.data.length,'wxIDæŸ¥åˆ—è¡¨æ•°æ®å¤§äº0è¯æ˜ç»‘å®šäº†')
          if (res.data.length > 0) { // å¤§äº0è¯æ˜ç»‘å®šäº†è”ç³»äººï¼Œè·³è½¬åˆ°è”ç³»äººè¯¦æƒ…é¡µé¢
            this.$toast.clear();
            this.userInfo = res.data[0]; // ç¬¬ä¸€ä¸ªå®¢æˆ·æ•°æ®èµ‹å€¼ï¼›å±•ç¤ºè¯¥æ•°æ®
            sessionStorage.setItem('tabNum', 0); // ä¿å­˜æ•°æ®å¹¶ä¸”è·³è½¬
            sessionStorage.setItem('_crm_info', JSON.stringify(res.data[0]))
            this.$router.push({ name: 'LinkDetailed' });
          } else {
            // æ²¡æœ‰ç»‘å®šè”ç³»äººã€‚è·³åˆ°æ–°å¢è”ç³»äººé¡µé¢
            console.log(this.wxcrmId, this.name, 'this.wxcrmId, name: this.name')
            this.getName() // åªæœ‰æ•°ç»„å¤§äº0åœ¨å»è¯·æ±‚åå­—æ¥å£;
            // this.$router.push({ name: 'Addcustomer', params: { wxcrmId: this.wxcrmId, name: this.name } });
          }
        })
        .catch(function (error) { });
    },
    rand(min = 1000, max = 9999) { // éšæœºè·å–å››ä½æ•°å­—
      return Math.floor(Math.random() * (max - min)) + min;
    },
    getName() { // è·å–å½“å‰å®¢æˆ·çš„ä¼ä¸šå¾®ä¿¡åå­—
      // return new Promise((resolve, reject) => {
      this.$get("/wx-crm-server/wx/get/customer/info", {
        params: {
          external_userid: this.wxcrmId,
          itrId: this.$U || local.U(),
        },
      }).then((res) => {
        if (res.data && res.data.external_contact && res.data.external_contact.name) {
          this.name = res.data.external_contact.name;
        } else {
          this.name = 'ä¼ä¸šå¾®ä¿¡ç”¨æˆ·' + this.rand();
        }
        this.$toast.clear();
        this.$router.push({ name: 'Addcustomer', params: { wxcrmId: this.wxcrmId, name: this.name } });
        // resolve(this.name);
      }).catch(function (error) {
        // reject(error);
      });
      // })
    },
    wxxxx() {
      let that = this;
      return new Promise(function (resolve, reject) {
        let begin = setInterval(async () => {
          console.log("ğŸš€ ~ file: ChatCustomer.vue ~ line 145 ~ begin=setInterval ~ that.accomplish", that.accomplish)
          if (that.accomplish) {
            // wxxx(); // æ‹‰å»ä¼ä¸šå¾®ä¿¡æˆæƒã€
            wxxxChat().then(res => {
              console.log(res, 'wwwww')
              that.wxcrmId = res;
              resolve(res)
            }).catch(error => {
              reject(error)
              console.log(error, 'wwwxxxx')
            })
            // await wxxxChat().then(res => {
            //   console.log(res)
            //   resolve(res)
            // }).catch(error => {
            //   console.log(error)
            // });
            // console.log('CHJATCURST', wxiD)
            clearInterval(begin); // æ¸…ç©ºå®šæ—¶å™¨
          }
        }, 500)
      })
    },
    getCurEx() {
      return new Promise((resolve, reject) => {
        let that = this;
        setTimeout(() => {
          wx.invoke('getCurExternalContact', {
          }, function (res) {
            if (res.err_msg == "getCurExternalContact:ok") {
              that.wxcrmId = res.userId;
              resolve(res)
            } else {
              //é”™è¯¯å¤„ç†
              that.$toast.fail({
                message: 'å®¢æˆ·IDè·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•...',
                forbidClick: true,
                duration: 0,
                overlay: true,
              });
              reject(res)
            }
          });
        }, 2000)
      })
    },
    init() { // åˆå§‹åŒ–è¯·æ±‚
      this.$toast.loading({
        message: 'åŠ è½½ä¸­...',
        forbidClick: false,
        duration: 0,
        overlay: true,
      });
      this.wxxxx().then(res => { // ä¼ä¸šå¾®ä¿¡æˆæƒ
        console.log(res, 'wxIDidIDIDIDID')ã€‚
        // return this.getName(); // è·å–åå­—
        this.verifyWxId()
        // return this.getCurEx(); // è·å–ä¼ä¸šå¾®ä¿¡å®¢æˆ·ID
      }).catch(error => {
        console.log(error)
      }).then(res => {
        // this.wxcrmId = res.userId;
        // return this.getName(); // è·å–åå­—
      }).catch(error => {
        console.log(error)
      }).then(res => {
        // console.log(res, ;'æˆ‘è¦name')
        // this.verifyWxId()
      })
      sessionStorage.setItem('active', 'ChatCustomer')
    },
    async BindCompletes() { // å…³é—­å¼¹æ¡†
      this.show = false;
      await this.getUserinfo();  // é‡æ–°æ‹‰å»ä¿¡æ¯æ¥å£ã€‚
    }
  },
  async created() {
    this.$toast.loading({
      message: 'åŠ è½½ä¸­...',
      forbidClick: false,
      duration: 0,
      overlay: true,
    });
    // if (sessionStorage.getItem("not_bind")) return;
    // console.log('222222222');
    // this.init()
    // wxxx()
    // setTimeout(() => {
    //   console.log('first2')
    //   let that = this;
    //   wx.invoke('getCurExternalContact', {
    //   }, function (res) {
    //     if (res.err_msg == "getCurExternalContact:ok") {
    //       that.wxcrmId = res.userId;
    //       console.log(res.userId, 'res.userIdres.userIdres.userId')
    //     } else {
    //       //é”™è¯¯å¤„ç†
    //       that.$toast.fail({
    //         message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•...',
    //         forbidClick: true,
    //         duration: 0,
    //         overlay: true,
    //       });
    //     }
    //   });
    // }, 2000)
    // setTimeout(async () => {
    //   await this.getName(); // è·å–åå­—
    //   this.verifyWxId();
    // }, 2500)
  },
};
</script>


  // changeSelectTag() { // ä¸‹æ‹‰é€‰æ‹©å™¨ changeäº‹ä»¶
    //   console.log(this.TagList[this.SelectTag])
    //   this.SelectTagList = this.TagList[this.SelectTag].tags;
    // },
    // addTag(type) { // æ–°å¢æ ‡ç­¾ type1æ ‡ç­¾ 2æ ‡ç­¾ç»„
    //   let signature = generateSignature3(0, 40000013, 13394171296, timeout, nonce);
    //   if (type == 1) {
    //     if (this.SelectTag === '' || this.Tagname === '') {
    //       this.$toast("è¯·é€‰æ‹©æ ‡ç­¾ç»„ï¼Œå¹¶ä¸”è¾“å…¥æ ‡ç­¾åå­—")
    //       return;
    //     }
    //   } else {
    //     if (this.Tagname === '') {
    //       this.$toast("è¯·è¾“å…¥æ ‡ç­¾ç»„åå­—")
    //     }
    //   }
    //   // è¿‡æ»¤æ•°ç»„ï¼š
    //   let params = {
    //     signature,
    //     timeout,
    //     nonce,
    //     userId: 13394171296,
    //     compId: 40000013,
    //     id: type == 2 ? 0 : 0,
    //     name: this.Tagname,
    //     sort: this.TagList.length,
    //     parentId: type == 2 ? 0 : this.TagList[this.SelectTag].id,
    //     tag: type == 2 ? null : encodeURI(JSON.stringify([{ id: "0", name: this.Tagname, "sort": 99 }])),
    //   }
    //   console.log([{ id: "0", name: this.Tagname, "sort": 99 }])
    //   this.$get("/api/request/crm/tag/save", { params })
    //     .then((res) => {
    //       if (res.error == 'success') {
    //         this.getTagList(1) // æ‹‰å–æ•°æ® å¹¶ä¸”æ›´æ–°æ ‡ç­¾
    //       } else {
    //         this.$toast.fail("å†…éƒ¨é”™è¯¯")
    //       }
    //       this.Tagname = ''
    //       console.log(res)
    //     })
    //     .catch((error) => {
    //       console.log(error);
    //     });
    // },
    // deleTag(item, index, type) {  // åˆ é™¤æ ‡ç­¾
    //   console.log(item, index, type)
    //   let param = new URLSearchParams();
    //   let signature = generateSignature3(40000013, 13394171296, timeout, nonce);
    //   param.append("ids", item.id);
    //   param.append("userId", 13394171296);
    //   param.append("compId", 40000013);
    //   param.append("signature", signature);
    //   param.append("timeout", timeout);
    //   param.append("nonce", nonce);
    //   this.$post1("/api/request/crm/tag/delete", param)
    //     .then((res) => {
    //       console.log(res)
    //       if (res.error == 'success') {
    //         this.getTagList(type)
    //       } else {
    //         this.$toast.fail("åˆ é™¤å¤±è´¥")
    //       }
    //     })
    //     .catch((error) => {
    //       console.log(error);
    //     });
    // },
    allocation() {
      // let param = {
      //   handover_userid: sessionStorage.getItem("bind_UserID"),
      //   takeover_userid: this.takeover_userid,
      //   external_userid: [sessionStorage.getItem('wxcrmId')],
      //   compId: this.userInfos().bind_comp_id1,
      //   transfer_success_msg: 'æ‚¨å¥½ï¼Œæ‚¨çš„æœåŠ¡å·²ç»å‡çº§ï¼Œåç»­å°†ç”±æˆ‘çš„åŒäº‹',
      // };
      // ç©ºæ ¡éªŒ;
      // if (this.takeover_userid === '') {
      //   this.$toast('è¯·é€‰æ‹©åˆ†é…çš„å‘˜å·¥')
      // }else {
      //   this.$toast.fail('å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ï¼')
      // }
      return;
      let param = {
        handover_userid: 'SongTianYu',
        takeover_userid: 'MoMo',
        external_userid: ['wmmmFVEAAAQbwte-CPVAc-zHKbGgErzA'],
        compId: 40021450,
        transfer_success_msg: 'æ‚¨å¥½ï¼Œæ‚¨çš„æœåŠ¡å·²ç»å‡çº§ï¼Œåç»­å°†ç”±æˆ‘çš„åŒäº‹æ¥æ›¿æˆ‘çš„å·¥ä½œï¼Œç»§ç»­ä¸ºæ‚¨æœåŠ¡ï¼',
      };
      this.$post1("/wx-crm-server/wx/staff/transfer/customer", param)
        .then((res) => {
          console.log(res);
        })
        .catch((error) => {
          console.log(error);
        });
    },